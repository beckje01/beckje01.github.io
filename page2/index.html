<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Jeff Beck</title>
  <meta name="author" content="Jeff Beck">

  
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="https://beckje01.com/page2/">
  <link href="/favicon.png" type="image/png" rel="icon">
  <link href="/atom.xml" rel="alternate" title="Jeff Beck" type="application/atom+xml">

  <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.1.0/css/font-awesome.min.css" rel="stylesheet">


  <link href="/assets/bootstrap/dist/css/bootstrap.min.css" rel="stylesheet" type="text/css">
<link href="/assets/bootstrap/dist/css/bootstrap-theme.min.css" rel="stylesheet" type="text/css">
<link rel="stylesheet" href="/assets/css/screen.css" />

  <script src="/javascripts/libs/jquery/jquery-2.0.3.min.js"></script>
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-41150211-4']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>
</head>
  <body   >
    <div id="wrap">
      <header role="banner">
        <nav class="navbar navbar-default" role="navigation">
    <div class="container">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/">Jeff Beck</a>
        </div>

        <div class="navbar-collapse collapse">
            <ul class="nav navbar-nav">
                <li class="active">
                    <a href="/">Blog</a>
                </li>
                <li >
                    <a href="/about">About</a>
                </li>
                <li >
                    <a href="/blog/archives">Archives</a>
                </li>
            </ul>
            <ul class="nav navbar-nav navbar-right">
                <li>
                  <a href="https://twitter.com/beckje01"  class="icon-link" title="Twitter Profile">
                    <span class="visible-xs">Twitter Profile</span>
                    <span class="hidden-xs"><i class="fa fa-twitter fa-jeff175"></i></span>
                  </a>
                </li>
                <li>
                  <a href="https://github.com/beckje01"  class="icon-link" title="GitHub Profile">
                    <span class="visible-xs">GitHub Profile</span>
                    <span class="hidden-xs"><i class="fa fa-github fa-jeff175"></i></span>

                  </a>
                </li>
                <li>
                    <a class="subscribe-rss icon-link" href="/atom.xml" title="subscribe via RSS">
                        <span class="visible-xs">RSS</span>
                        <span class="hidden-xs"><i class="fa fa-rss fa-jeff175"></i></span>
                    </a>
                </li>
                
            </ul>
            
                <form class="search navbar-form navbar-right" action="https://www.google.com/search" method="GET">
                    <input type="hidden" name="q" value="site:https://beckje01.com">
                    <div class="form-group">
                        <input class="form-control" type="text" name="q" placeholder="Search">
                    </div>
                </form>
            
        </div>
    </div>
</nav>
      </header>
      <div id="main" class="container">
        <div id="content">
          <div class="row">
  <div class="page-content col-md-9">
    <div class="blog-index">
      
      
      
        <article class="post">
          <header class="page-header">
    
      <p class="meta text-muted text-uppercase">
        <span class="glyphicon glyphicon-calendar"></span> <time datetime="2014-09-10T15:33:46-05:00" pubdate class="published updated" >Sep 10, 2014</time>
        
      </p>
    
    
      <h1 class="entry-title"><a href="/blog/2014/09/10/ratpack-promise/">Ratpack Promise</a></h1>
    
  </header>


  <div class="entry-content clearfix"><p>Ratpack has a core class that is the center of the great asynchronous support, <a href="http://www.ratpack.io/manual/current/api/index.html?ratpack/exec/Promise.html">Promise</a>.</p>

<p>Ratpack Promises are very easy to work with, there are just a few key points:</p>

<ul>
<li>Only attach to a promise one time</li>
<li>If dealing with the error case it must be done before the success case</li>
<li>They are Lazy</li>
<li>In Groovy we depend on <a href="http://mrhaki.blogspot.com/2013/11/groovy-goodness-implicit-closure.html">Implicit Closure Coercion</a> to change our closures to an Action.</li>
</ul>


<h2>Happy Path</h2>

<p><figure class='code-highlight-figure'><figcaption class='code-highlight-caption'><span class='code-highlight-caption-title'>Consuming Value from Promise</span></figcaption><div class='code-highlight'><pre class='code-highlight-pre'><div data-line='1' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="n">Promise</span> <span class="n">promise</span> <span class="o">=</span> <span class="n">somethingThatReturnsPromise</span><span class="o">()</span>
</div></div><div data-line='2' class='code-highlight-row numbered'><div class='code-highlight-line'> </div></div><div data-line='3' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="n">promise</span><span class="o">.</span><span class="na">then</span> <span class="o">&#x7b;</span>
</div></div><div data-line='4' class='code-highlight-row numbered'><div class='code-highlight-line'>  <span class="n">println</span> <span class="n">it</span>
</div></div><div data-line='5' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="o">&#x7d;</span>
</div></div></pre></div></figure></p>

<p>What we are doing here is giving a closure to the promise that once the value is ready the closure will be called with the value passed in as a parameter. We can also be very explicit in what we are getting back from the promise.</p>

<p><figure class='code-highlight-figure'><figcaption class='code-highlight-caption'><span class='code-highlight-caption-title'>Explicit Value from Promise</span></figcaption><div class='code-highlight'><pre class='code-highlight-pre'><div data-line='1' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="kt">def</span> <span class="n">p</span> <span class="o">=</span> <span class="n">httpClient</span><span class="o">.</span><span class="na">get</span> <span class="o">&#x7b;</span>
</div></div><div data-line='2' class='code-highlight-row numbered'><div class='code-highlight-line'>  <span class="n">it</span><span class="o">.</span><span class="na">url</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="k">new</span> <span class="n">URI</span><span class="o">(</span><span class="s2">&ldquo;<a href="http://example.com">http://example.com</a>&rdquo;</span><span class="o">))</span>
</div></div><div data-line='3' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="o">&#x7d;</span>
</div></div><div data-line='4' class='code-highlight-row numbered'><div class='code-highlight-line'> </div></div><div data-line='5' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="n">p</span><span class="o">.</span><span class="na">then</span> <span class="o">&#x7b;</span> <span class="n">ReceivedResponse</span> <span class="n">receivedResponse</span> <span class="o">-&gt;</span>
</div></div><div data-line='6' class='code-highlight-row numbered'><div class='code-highlight-line'>  <span class="n">println</span> <span class="n">receivedResponse</span><span class="o">.</span><span class="na">statusCode</span>
</div></div><div data-line='7' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="o">&#x7d;</span>
</div></div></pre></div></figure></p>

<p>If some error occurs while trying to get the value for the <code>then</code> block the exception will be thrown. Which can be picked up by some error handler down the chain.</p>

<h2>Error Callback</h2>

<p>So for this works great when dealing with the happy path and wanting exceptions. But we also may want to deal with failures to fulfill the promise. So to do this we start with <code>onError</code> instead of <code>then</code>.</p>

<p><figure class='code-highlight-figure'><figcaption class='code-highlight-caption'><span class='code-highlight-caption-title'>Ratpack Promise with Failure Path</span></figcaption><div class='code-highlight'><pre class='code-highlight-pre'><div data-line='1' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="n">httpClient</span><span class="o">.</span><span class="na">get</span> <span class="o">&#x7b;</span>
</div></div><div data-line='2' class='code-highlight-row numbered'><div class='code-highlight-line'>    <span class="n">it</span><span class="o">.</span><span class="na">url</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="k">new</span> <span class="n">URI</span><span class="o">(</span><span class="s2">&ldquo;<a href="http://example.com">http://example.com</a>&rdquo;</span><span class="o">))</span>
</div></div><div data-line='3' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="o">&#x7d;</span> <span class="n">onError</span> <span class="o">&#x7b;</span>
</div></div><div data-line='4' class='code-highlight-row numbered'><div class='code-highlight-line'>    <span class="n">println</span> <span class="s2">&ldquo;Something when wrong: $&#x7b;it.message&#x7d;&rdquo;</span>
</div></div><div data-line='5' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="o">&#x7d;</span> <span class="n">then</span> <span class="o">&#x7b;</span>
</div></div><div data-line='6' class='code-highlight-row numbered'><div class='code-highlight-line'>    <span class="n">render</span> <span class="s2">&ldquo;Got a $&#x7b;it.statusCode&#x7d; status with body of:\n\n$&#x7b;it.body.text&#x7d;&rdquo;</span>
</div></div><div data-line='7' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="o">&#x7d;</span>
</div></div></pre></div></figure></p>

<p><code>onError</code> will pass in a throwable to the closure that you can log or do whatever work you would like in the case of a failure.</p>

<h2>Lazy Promises</h2>

<p>Ratpack promises won&rsquo;t actually try to generate the value until the <code>then</code> block is called at the end of the current execution. This is done to allow for deterministic asynchronous operations.</p>

<p><figure class='code-highlight-figure'><figcaption class='code-highlight-caption'><span class='code-highlight-caption-title'>Deterministic Promise</span></figcaption><div class='code-highlight'><pre class='code-highlight-pre'><div data-line='1' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="kt">def</span> <span class="nf">doWork</span><span class="o">()</span> <span class="o">&#x7b;</span>
</div></div><div data-line='2' class='code-highlight-row numbered'><div class='code-highlight-line'>  <span class="n">httpClient</span><span class="o">.</span><span class="na">get</span> <span class="o">&#x7b;</span> <span class="err">…</span> <span class="o">&#x7d;.</span><span class="na">then</span> <span class="o">&#x7b;</span> <span class="err">…</span> <span class="o">&#x7d;</span>
</div></div><div data-line='3' class='code-highlight-row numbered'><div class='code-highlight-line'>  <span class="n">sleep</span> <span class="mi">5000</span>
</div></div><div data-line='4' class='code-highlight-row numbered'><div class='code-highlight-line'>  <span class="k">throw</span> <span class="k">new</span> <span class="nf">RuntimeException</span><span class="o">(</span><span class="s2">&ldquo;bang!&rdquo;</span><span class="o">)</span>
</div></div><div data-line='5' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="o">&#x7d;</span>
</div></div></pre></div></figure></p>

<p>What will happen in Ratpack is we will always get the exception &ldquo;bang!&rdquo;, because the get request will not even get started until the <code>doWork</code> block of execution is finished. Once finished having a <code>then{}</code> will trigger a background thread to start generating the value.</p>

<h2>What not to do</h2>

<p>You shouldn&rsquo;t try to attach more than once to a Promise, as what ends up happening is two different promise instances will execute in the background and what we want is only to deal with that value once. So don&rsquo;t do the following:</p>

<p><figure class='code-highlight-figure'><figcaption class='code-highlight-caption'><span class='code-highlight-caption-title'>Don&rsquo;t do this</span></figcaption><div class='code-highlight'><pre class='code-highlight-pre'><div data-line='1' class='code-highlight-row numbered'><div class='code-highlight-line'> </div></div><div data-line='2' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="kt">def</span> <span class="n">p</span> <span class="o">=</span> <span class="n">httpClient</span><span class="o">.</span><span class="na">get</span> <span class="o">&#x7b;</span>
</div></div><div data-line='3' class='code-highlight-row numbered'><div class='code-highlight-line'>  <span class="n">it</span><span class="o">.</span><span class="na">url</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="k">new</span> <span class="n">URI</span><span class="o">(</span><span class="s2">&ldquo;<a href="http://example.com">http://example.com</a>&rdquo;</span><span class="o">))</span>
</div></div><div data-line='4' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="o">&#x7d;</span>
</div></div><div data-line='5' class='code-highlight-row numbered'><div class='code-highlight-line'> </div></div><div data-line='6' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="n">p</span><span class="o">.</span><span class="na">onError</span> <span class="o">&#x7b;</span>
</div></div><div data-line='7' class='code-highlight-row numbered'><div class='code-highlight-line'>  <span class="n">println</span> <span class="n">it</span>
</div></div><div data-line='8' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="o">&#x7d;</span>
</div></div><div data-line='9' class='code-highlight-row numbered'><div class='code-highlight-line'> </div></div><div data-line='10' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="n">p</span><span class="o">.</span><span class="na">then</span> <span class="o">&#x7b;</span>
</div></div><div data-line='11' class='code-highlight-row numbered'><div class='code-highlight-line'>  <span class="n">println</span> <span class="n">it</span><span class="o">.</span><span class="na">statusCode</span>
</div></div><div data-line='12' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="o">&#x7d;</span>
</div></div></pre></div></figure></p>

<p>Starting in Ratpack 0.9.9 the above code should actually throw an error.</p>
</div>
        </article>
      
      
        <article class="post">
          <header class="page-header">
    
      <p class="meta text-muted text-uppercase">
        <span class="glyphicon glyphicon-calendar"></span> <time datetime="2014-08-13T18:16:00-05:00" pubdate class="published updated" >Aug 13, 2014</time>
        
      </p>
    
    
      <h1 class="entry-title"><a href="/blog/2014/08/13/cassandra-upsert-everything/">Cassandra Upsert Everything</a></h1>
    
  </header>


  <div class="entry-content clearfix"><p>Cassandra inserts and updates should always be modeled as upserts when possible. Using the query builder in the Java native driver there isn&rsquo;t a direct upsert called out, but we can do updates instead of inserts for all cases. The update acts as an upsert and it reduces the number of queries you will need to build.</p>

<p><figure class='code-highlight-figure'><div class='code-highlight'><pre class='code-highlight-pre'><div data-line='1' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="n">Statement</span> <span class="n">upsert</span> <span class="o">=</span> <span class="n">QueryBuilder</span><span class="o">.</span><span class="na">update</span><span class="o">(</span><span class="s">&ldquo;table&rdquo;</span><span class="o">)</span>
</div></div><div data-line='2' class='code-highlight-row numbered'><div class='code-highlight-line'>        <span class="o">.</span><span class="na">with</span><span class="o">(</span><span class="n">QueryBuilder</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="s">&ldquo;visits&rdquo;</span><span class="o">,</span> <span class="k">new</span> <span class="n">Date</span><span class="o">()))</span> <span class="c1">//Add to a CQL3 List</span>
</div></div><div data-line='3' class='code-highlight-row numbered'><div class='code-highlight-line'>        <span class="o">.</span><span class="na">where</span><span class="o">(</span><span class="n">QueryBuilder</span><span class="o">.</span><span class="na">eq</span><span class="o">(</span><span class="s">&ldquo;id&rdquo;</span><span class="o">,</span> <span class="s">&ldquo;MyID&rdquo;</span><span class="o">));</span>
</div></div><div data-line='4' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="n">session</span><span class="o">.</span><span class="na">execute</span><span class="o">(</span><span class="n">upsert</span><span class="o">);</span>
</div></div></pre></div></figure></p>

<p>Above you can see how we model our &ldquo;upsert&rdquo;. If a value isn&rsquo;t found for the given where clause it will insert it.</p>

<p>You must use all parts of a Primary Key for an updates where cluase given a CQL Table with a compound key:</p>

<p><figure class='code-highlight-figure'><div class='code-highlight'><pre class='code-highlight-pre'><div data-line='1' class='code-highlight-row numbered'><div class='code-highlight-line'>create table tablex(
</div></div><div data-line='2' class='code-highlight-row numbered'><div class='code-highlight-line'>     pk1 varchar,
</div></div><div data-line='3' class='code-highlight-row numbered'><div class='code-highlight-line'>     pk2 varchar,
</div></div><div data-line='4' class='code-highlight-row numbered'><div class='code-highlight-line'>     colA varchar,
</div></div><div data-line='5' class='code-highlight-row numbered'><div class='code-highlight-line'>     PRIMARY KEY(pk1,pk2)
</div></div><div data-line='6' class='code-highlight-row numbered'><div class='code-highlight-line'>);
</div></div></pre></div></figure></p>

<p>We can not do the following query:</p>

<p><figure class='code-highlight-figure'><div class='code-highlight'><pre class='code-highlight-pre'><div data-line='1' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="n">Statement</span> <span class="n">upsert</span> <span class="o">=</span> <span class="n">QueryBuilder</span><span class="o">.</span><span class="na">update</span><span class="o">(</span><span class="s">&ldquo;tablex&rdquo;</span><span class="o">)</span>
</div></div><div data-line='2' class='code-highlight-row numbered'><div class='code-highlight-line'>                <span class="o">.</span><span class="na">with</span><span class="o">(</span><span class="n">QueryBuilder</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="s">&ldquo;colA&rdquo;</span><span class="o">,</span> <span class="s">&ldquo;2&rdquo;</span><span class="o">))</span>
</div></div><div data-line='3' class='code-highlight-row numbered'><div class='code-highlight-line'>                <span class="o">.</span><span class="na">where</span><span class="o">(</span><span class="n">QueryBuilder</span><span class="o">.</span><span class="na">eq</span><span class="o">(</span><span class="s">&ldquo;pk1&rdquo;</span><span class="o">,</span> <span class="s">&ldquo;1&rdquo;</span><span class="o">));</span>
</div></div></pre></div></figure></p>

<p>You will get an <code>InvalidQueryException</code>:</p>

<p><figure class='code-highlight-figure'><div class='code-highlight'><pre class='code-highlight-pre'><div data-line='1' class='code-highlight-row numbered'><div class='code-highlight-line'>com.datastax.driver.core.exceptions.InvalidQueryException: Missing mandatory PRIMARY KEY part pk2
</div></div><div data-line='2' class='code-highlight-row numbered'><div class='code-highlight-line'>    com.datastax.driver.core.exceptions.InvalidQueryException.copy(InvalidQueryException.java:35)
</div></div><div data-line='3' class='code-highlight-row numbered'><div class='code-highlight-line'>    com.datastax.driver.core.DefaultResultSetFuture.extractCauseFromExecutionException(DefaultResultSetFuture.java:256)
</div></div><div data-line='4' class='code-highlight-row numbered'><div class='code-highlight-line'>    com.datastax.driver.core.DefaultResultSetFuture.getUninterruptibly(DefaultResultSetFuture.java:172)
</div></div></pre></div></figure></p>

<p>But the following will upsert:</p>

<p><figure class='code-highlight-figure'><div class='code-highlight'><pre class='code-highlight-pre'><div data-line='1' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="n">Statement</span> <span class="n">upsert</span> <span class="o">=</span> <span class="n">QueryBuilder</span><span class="o">.</span><span class="na">update</span><span class="o">(</span><span class="s">&ldquo;tablex&rdquo;</span><span class="o">)</span>
</div></div><div data-line='2' class='code-highlight-row numbered'><div class='code-highlight-line'>        <span class="o">.</span><span class="na">with</span><span class="o">(</span><span class="n">QueryBuilder</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="s">&ldquo;colA&rdquo;</span><span class="o">,</span> <span class="s">&ldquo;2&rdquo;</span><span class="o">))</span>
</div></div><div data-line='3' class='code-highlight-row numbered'><div class='code-highlight-line'>        <span class="o">.</span><span class="na">where</span><span class="o">(</span><span class="n">QueryBuilder</span><span class="o">.</span><span class="na">eq</span><span class="o">(</span><span class="s">&ldquo;pk1&rdquo;</span><span class="o">,</span> <span class="s">&ldquo;1&rdquo;</span><span class="o">))</span>
</div></div><div data-line='4' class='code-highlight-row numbered'><div class='code-highlight-line'>        <span class="o">.</span><span class="na">and</span><span class="o">(</span><span class="n">QueryBuilder</span><span class="o">.</span><span class="na">eq</span><span class="o">(</span><span class="s">&ldquo;pk2&rdquo;</span><span class="o">,</span> <span class="s">&ldquo;2&rdquo;</span><span class="o">));</span>
</div></div></pre></div></figure></p>
</div>
        </article>
      
      
        <article class="post">
          <header class="page-header">
    
      <p class="meta text-muted text-uppercase">
        <span class="glyphicon glyphicon-calendar"></span> <time datetime="2014-07-25T06:54:30-05:00" pubdate class="published updated" >Jul 25, 2014</time>
        
      </p>
    
    
      <h1 class="entry-title"><a href="/blog/2014/07/25/failing-at-grab-fixes/">Failing @Grab Fixes</a></h1>
    
  </header>


  <div class="entry-content clearfix"><p>If you are working on a Groovy script with @Grab, you will sometimes get download failures for dependencies. Such as the following:</p>

<p><figure class='code-highlight-figure'><div class='code-highlight'><pre class='code-highlight-pre'><div data-line='1' class='code-highlight-row numbered'><div class='code-highlight-line'>General error during conversion: Error grabbing Grapes &ndash; [download failed: com.google.guava#guava;16.0!guava.jar(bundle), download failed: org.javassist#javassist;3.18.1-GA!javassist.jar(bundle)]
</div></div></pre></div></figure></p>

<p>This issues may have nothing to do with the actual dependency but an issue in your local m2 cache. The quick answer is to just delete <code>~/.groovy/grapes</code> and <code>~/.m2/repository</code>. But doing this will force you to re-download dependencies.</p>

<p>To only delete the cache for items giving you an issue you just need to delete the correct directories in both m2 and grapes cache. So for our Guava example you would do the following:</p>

<p><figure class='code-highlight-figure'><div class='code-highlight'><pre class='code-highlight-pre'><div data-line='1' class='code-highlight-row numbered'><div class='code-highlight-line'>rm -r ~/.groovy/grapes/com.google.guava
</div></div><div data-line='2' class='code-highlight-row numbered'><div class='code-highlight-line'>rm -r ~/.m2/repository/com/google/guava
</div></div></pre></div></figure></p>

<p>After that you should be able to run the groovy script normally.</p>
</div>
        </article>
      
      
        <article class="post">
          <header class="page-header">
    
      <p class="meta text-muted text-uppercase">
        <span class="glyphicon glyphicon-calendar"></span> <time datetime="2014-07-03T09:36:21-05:00" pubdate class="published updated" >Jul 03, 2014</time>
        
      </p>
    
    
      <h1 class="entry-title"><a href="/blog/2014/07/03/grails-new-relic-detailed-tracing/">Grails New Relic Detailed Tracing</a></h1>
    
  </header>


  <div class="entry-content clearfix"><p>New Relic with Grails by default will trace most web transactions through the controller but will not trace down into services. While most true work of a request belongs in services or libraries the default tracing leaves something to be desired.</p>

<p>This is easily fixed by adding New Relic annotations to services and libraries.</p>

<h3>BuildConfig.groovy Changes</h3>

<p><figure class='code-highlight-figure'><div class='code-highlight'><pre class='code-highlight-pre'><div data-line='1' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="n">dependencies</span> <span class="o">&#x7b;</span>
</div></div><div data-line='2' class='code-highlight-row numbered'><div class='code-highlight-line'>    <span class="n">compile</span> <span class="s1">&lsquo;com.newrelic.agent.java:newrelic-api:3.4.2&rsquo;</span>
</div></div><div data-line='3' class='code-highlight-row numbered'><div class='code-highlight-line'> </div></div><div data-line='4' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="o">&#x7d;</span>
</div></div></pre></div></figure></p>

<h3>Service Changes</h3>

<p><figure class='code-highlight-figure'><div class='code-highlight'><pre class='code-highlight-pre'><div data-line='1' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="kn">import</span> <span class="nn">com.newrelic.api.agent.Trace</span>
</div></div><div data-line='2' class='code-highlight-row numbered'><div class='code-highlight-line'> </div></div><div data-line='3' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="kd">class</span> <span class="nc">SubscriptionService</span> <span class="o">&#x7b;</span>
</div></div><div data-line='4' class='code-highlight-row numbered'><div class='code-highlight-line'> </div></div><div data-line='5' class='code-highlight-row numbered'><div class='code-highlight-line'>   <span class="nd">@Trace</span>
</div></div><div data-line='6' class='code-highlight-row numbered'><div class='code-highlight-line'>    <span class="kt">def</span> <span class="nf">save</span><span class="o">(</span><span class="n">Subscription</span> <span class="n">subscription</span><span class="o">)</span> <span class="o">&#x7b;</span>
</div></div><div data-line='7' class='code-highlight-row numbered'><div class='code-highlight-line'>    <span class="c1">//Work Here</span>
</div></div><div data-line='8' class='code-highlight-row numbered'><div class='code-highlight-line'>  <span class="o">&#x7d;</span>
</div></div></pre></div></figure></p>

<p>At this point your code is ready to give more detailed transactions, but the agent on the server must also be configured to accept custom tracing. The config option for this is not available from the web so you must update the <code>newrelic.yml</code> file. Set <code>enable_custom_tracing</code> to <code>true</code>.</p>

<p><figure class='code-highlight-figure'><div class='code-highlight'><pre class='code-highlight-pre'><div data-line='1' class='code-highlight-row numbered'><div class='code-highlight-line'>  <span class="c1">#enable_custom_tracing is used to allow @Trace on methods</span>
</div></div><div data-line='2' class='code-highlight-row numbered'><div class='code-highlight-line'>  <span class="na">enable_custom_tracing</span><span class="pi">:</span> <span class="no">true</span>
</div></div></pre></div></figure></p>

<p>Now you will get any custom tracing added to your application as well as custom tracing from libraries.</p>
</div>
        </article>
      
      
        <article class="post">
          <header class="page-header">
    
      <p class="meta text-muted text-uppercase">
        <span class="glyphicon glyphicon-calendar"></span> <time datetime="2013-10-23T04:02:02-05:00" pubdate class="published updated" >Oct 23, 2013</time>
        
      </p>
    
    
      <h1 class="entry-title"><a href="/blog/2013/10/23/grails-2-3-1-warnings-after-clean/">Grails 2.3.1 Warnings After Clean.</a></h1>
    
  </header>


  <div class="entry-content clearfix"><p>If you are running grails 2.3.1 and see the following sequence pop up before you get some odd test failures.</p>

<p><figure class='code-highlight-figure'><div class='code-highlight'><pre class='code-highlight-pre'><div data-line='1' class='code-highlight-row numbered'><div class='code-highlight-line'>    <span class="nv">$ </span>grails clean
</div></div><div data-line='2' class='code-highlight-row numbered'><div class='code-highlight-line'>    | Application cleaned.
</div></div><div data-line='3' class='code-highlight-row numbered'><div class='code-highlight-line'> </div></div><div data-line='4' class='code-highlight-row numbered'><div class='code-highlight-line'>    <span class="nv">$ </span>grails test-app
</div></div><div data-line='5' class='code-highlight-row numbered'><div class='code-highlight-line'>    | Environment <span class="nb">set </span>to test&hellip;..
</div></div><div data-line='6' class='code-highlight-row numbered'><div class='code-highlight-line'>    | Warning No config found <span class="k">for </span>the application.
</div></div><div data-line='7' class='code-highlight-row numbered'><div class='code-highlight-line'>    | Warning DataSource.groovy not found, assuming dataSource bean is configured by Spring
</div></div></pre></div></figure></p>

<p>Start using package in between and the problem will go away.</p>

<p><figure class='code-highlight-figure'><div class='code-highlight'><pre class='code-highlight-pre'><div data-line='1' class='code-highlight-row numbered'><div class='code-highlight-line'>    <span class="nv">$ </span>grails clean
</div></div><div data-line='2' class='code-highlight-row numbered'><div class='code-highlight-line'>    | Application cleaned.
</div></div><div data-line='3' class='code-highlight-row numbered'><div class='code-highlight-line'>    <span class="nv">$ </span>grails package
</div></div><div data-line='4' class='code-highlight-row numbered'><div class='code-highlight-line'>    | Compiling 10 <span class="nb">source </span>files
</div></div><div data-line='5' class='code-highlight-row numbered'><div class='code-highlight-line'>    | Compiling 12 <span class="nb">source </span>files&hellip;..
</div></div><div data-line='6' class='code-highlight-row numbered'><div class='code-highlight-line'> </div></div><div data-line='7' class='code-highlight-row numbered'><div class='code-highlight-line'>    <span class="nv">$ </span>grails test-app
</div></div><div data-line='8' class='code-highlight-row numbered'><div class='code-highlight-line'>    | Environment <span class="nb">set </span>to test&hellip;..
</div></div><div data-line='9' class='code-highlight-row numbered'><div class='code-highlight-line'>    | Server running. Browse to <a href="http://localhost:8080/api">http://localhost:8080/api</a>
</div></div><div data-line='10' class='code-highlight-row numbered'><div class='code-highlight-line'>    | Running 6 cucumber tests&hellip;
</div></div><div data-line='11' class='code-highlight-row numbered'><div class='code-highlight-line'>    | Completed 6 cucumber tests, 0 failed <span class="k">in </span>0m 3s
</div></div><div data-line='12' class='code-highlight-row numbered'><div class='code-highlight-line'>    | Server stopped
</div></div><div data-line='13' class='code-highlight-row numbered'><div class='code-highlight-line'>    | Tests PASSED
</div></div></pre></div></figure></p>
</div>
        </article>
      
      
        <article class="post">
          <header class="page-header">
    
      <p class="meta text-muted text-uppercase">
        <span class="glyphicon glyphicon-calendar"></span> <time datetime="2013-08-19T18:10:12-05:00" pubdate class="published updated" >Aug 19, 2013</time>
        
      </p>
    
    
      <h1 class="entry-title"><a href="/blog/2013/08/19/grails-2-3-rc1-and-jms-plugin/">Grails 2.3 RC1 and JMS Plugin</a></h1>
    
  </header>


  <div class="entry-content clearfix"><p>Using the JMS 1.2 plugin with Grails 2.3.0.RC1 was producing a number of odd results. Mostly with missing JMS files it turns out that the new spring version didn’t have the needed spring jms included. Just add the following to BuildConfig.groovy</p>

<p><figure class='code-highlight-figure'><div class='code-highlight'><pre class='code-highlight-pre'><div data-line='1' class='code-highlight-row numbered'><div class='code-highlight-line'>    <span class="n">dependencies</span> <span class="o">&#x7b;</span>
</div></div><div data-line='2' class='code-highlight-row numbered'><div class='code-highlight-line'>      <span class="n">compile</span> <span class="s1">&lsquo;org.springframework:spring-jms:3.2.4.RELEASE&rsquo;</span>
</div></div><div data-line='3' class='code-highlight-row numbered'><div class='code-highlight-line'>      <span class="o">&hellip;</span>
</div></div><div data-line='4' class='code-highlight-row numbered'><div class='code-highlight-line'>    <span class="o">&#x7d;</span>
</div></div></pre></div></figure></p>
</div>
        </article>
      
      
        <article class="post">
          <header class="page-header">
    
      <p class="meta text-muted text-uppercase">
        <span class="glyphicon glyphicon-calendar"></span> <time datetime="2013-02-04T08:27:27-06:00" pubdate class="published updated" >Feb 04, 2013</time>
        
      </p>
    
    
      <h1 class="entry-title"><a href="/blog/2013/02/04/grails-custom-userdetailsservice-using-a-grails-service/">Grails Custom UserDetailsService Using a Grails Service</a></h1>
    
  </header>


  <div class="entry-content clearfix"><p>Using the Grails Spring Security Core Plugin I found the need to customize the UserDetailsService and use a Grails service. (Part of the roles logic depended on an external API that we already had a service for.) This was easy to accomplish by subclassing the UserDetailsService class I wanted as a base in my case it was actually the SpringSamlUserDetailsService class because I was using the SAML plugin but normally you would subclass GormUserDetailsService. A great starting example is given in the documentation <a href="http://grails-plugins.github.com/grails-spring-security-core/docs/manual/guide/11%20Custom%20UserDetailsService.html">here</a>.</p>

<p>The difference in my case was the need to use the Grails service, I went with providing the service in the resources.groovy file. Below is the example file of what I used.</p>

<p><strong>My <em>resources.groovy</em></strong></p>

<p><figure class='code-highlight-figure'><div class='code-highlight'><pre class='code-highlight-pre'><div data-line='1' class='code-highlight-row numbered'><div class='code-highlight-line'>    <span class="kn">import</span> <span class="nn">com.example.saml.CustomUserDetailsService</span>
</div></div><div data-line='2' class='code-highlight-row numbered'><div class='code-highlight-line'>    <span class="kn">import</span> <span class="nn">org.codehaus.groovy.grails.plugins.springsecurity.SpringSecurityUtils</span>
</div></div><div data-line='3' class='code-highlight-row numbered'><div class='code-highlight-line'> </div></div><div data-line='4' class='code-highlight-row numbered'><div class='code-highlight-line'>    <span class="n">beans</span> <span class="o">=</span> <span class="o">&#x7b;</span>
</div></div><div data-line='5' class='code-highlight-row numbered'><div class='code-highlight-line'>        <span class="n">userDetailsService</span><span class="o">(</span><span class="n">CustomUserDetailsService</span><span class="o">)</span> <span class="o">&#x7b;</span>
</div></div><div data-line='6' class='code-highlight-row numbered'><div class='code-highlight-line'>             <span class="n">grailsApplication</span> <span class="o">=</span> <span class="n">ref</span><span class="o">(</span><span class="s1">&lsquo;grailsApplication&rsquo;</span><span class="o">)</span>
</div></div><div data-line='7' class='code-highlight-row numbered'><div class='code-highlight-line'>             <span class="n">myService</span> <span class="o">=</span> <span class="n">ref</span><span class="o">(</span><span class="s1">&lsquo;myService&rsquo;</span><span class="o">)</span>  <span class="c1">//Here we give the reference to the service we want available.</span>
</div></div><div data-line='8' class='code-highlight-row numbered'><div class='code-highlight-line'>             <span class="n">authorityClassName</span> <span class="o">=</span> <span class="n">SpringSecurityUtils</span><span class="o">.</span><span class="na">securityConfig</span><span class="o">.</span><span class="na">authority</span><span class="o">.</span><span class="na">className</span>
</div></div><div data-line='9' class='code-highlight-row numbered'><div class='code-highlight-line'>             <span class="n">authorityJoinClassName</span> <span class="o">=</span> <span class="n">SpringSecurityUtils</span><span class="o">.</span><span class="na">securityConfig</span><span class="o">.</span><span class="na">userLookup</span><span class="o">.</span><span class="na">authorityJoinClassName</span>
</div></div><div data-line='10' class='code-highlight-row numbered'><div class='code-highlight-line'>            <span class="n">authorityNameField</span> <span class="o">=</span> <span class="n">SpringSecurityUtils</span><span class="o">.</span><span class="na">securityConfig</span><span class="o">.</span><span class="na">authority</span><span class="o">.</span><span class="na">nameField</span>
</div></div><div data-line='11' class='code-highlight-row numbered'><div class='code-highlight-line'>            <span class="n">samlAutoCreateActive</span> <span class="o">=</span> <span class="n">SpringSecurityUtils</span><span class="o">.</span><span class="na">securityConfig</span><span class="o">.</span><span class="na">saml</span><span class="o">.</span><span class="na">autoCreate</span><span class="o">.</span><span class="na">active</span>
</div></div><div data-line='12' class='code-highlight-row numbered'><div class='code-highlight-line'>            <span class="n">samlAutoAssignAuthorities</span> <span class="o">=</span> <span class="n">SpringSecurityUtils</span><span class="o">.</span><span class="na">securityConfig</span><span class="o">.</span><span class="na">saml</span><span class="o">.</span><span class="na">autoCreate</span><span class="o">.</span><span class="na">assignAuthorities</span> <span class="k">as</span> <span class="n">Boolean</span>
</div></div><div data-line='13' class='code-highlight-row numbered'><div class='code-highlight-line'>            <span class="n">samlAutoCreateKey</span> <span class="o">=</span> <span class="n">SpringSecurityUtils</span><span class="o">.</span><span class="na">securityConfig</span><span class="o">.</span><span class="na">saml</span><span class="o">.</span><span class="na">autoCreate</span><span class="o">.</span><span class="na">key</span> <span class="k">as</span> <span class="n">String</span>
</div></div><div data-line='14' class='code-highlight-row numbered'><div class='code-highlight-line'>            <span class="n">samlUserAttributeMappings</span> <span class="o">=</span> <span class="n">SpringSecurityUtils</span><span class="o">.</span><span class="na">securityConfig</span><span class="o">.</span><span class="na">saml</span><span class="o">.</span><span class="na">userAttributeMappings</span>
</div></div><div data-line='15' class='code-highlight-row numbered'><div class='code-highlight-line'>            <span class="n">samlUserGroupAttribute</span> <span class="o">=</span> <span class="n">SpringSecurityUtils</span><span class="o">.</span><span class="na">securityConfig</span><span class="o">.</span><span class="na">saml</span><span class="o">.</span><span class="na">userGroupAttribute</span> <span class="k">as</span> <span class="n">String</span>
</div></div><div data-line='16' class='code-highlight-row numbered'><div class='code-highlight-line'>            <span class="n">samlUserGroupToRoleMapping</span> <span class="o">=</span> <span class="n">SpringSecurityUtils</span><span class="o">.</span><span class="na">securityConfig</span><span class="o">.</span><span class="na">saml</span><span class="o">.</span><span class="na">userGroupToRoleMapping</span>
</div></div><div data-line='17' class='code-highlight-row numbered'><div class='code-highlight-line'>            <span class="n">userDomainClassName</span> <span class="o">=</span> <span class="n">SpringSecurityUtils</span><span class="o">.</span><span class="na">securityConfig</span><span class="o">.</span><span class="na">userLookup</span><span class="o">.</span><span class="na">userDomainClassName</span>
</div></div><div data-line='18' class='code-highlight-row numbered'><div class='code-highlight-line'>            <span class="n">authoritiesPropertyName</span> <span class="o">=</span> <span class="n">SpringSecurityUtils</span><span class="o">.</span><span class="na">securityConfig</span><span class="o">.</span><span class="na">userLookup</span><span class="o">.</span><span class="na">authoritiesPropertyName</span>
</div></div><div data-line='19' class='code-highlight-row numbered'><div class='code-highlight-line'>        <span class="o">&#x7d;</span>
</div></div><div data-line='20' class='code-highlight-row numbered'><div class='code-highlight-line'>    <span class="o">&#x7d;</span>
</div></div></pre></div></figure></p>

<p><strong>Snip from <em>CustomUserDetailsService.groovy</em></strong></p>

<p><figure class='code-highlight-figure'><div class='code-highlight'><pre class='code-highlight-pre'><div data-line='1' class='code-highlight-row numbered'><div class='code-highlight-line'>    <span class="kd">class</span> <span class="nc">CustomUserDetailsService</span> <span class="kd">extends</span> <span class="n">SpringSamlUserDetailsService</span> <span class="o">&#x7b;</span>
</div></div><div data-line='2' class='code-highlight-row numbered'><div class='code-highlight-line'>        <span class="kt">def</span> <span class="n">myService</span>
</div></div><div data-line='3' class='code-highlight-row numbered'><div class='code-highlight-line'>    <span class="o">&hellip;</span>
</div></div><div data-line='4' class='code-highlight-row numbered'><div class='code-highlight-line'>    <span class="o">&#x7d;</span>
</div></div></pre></div></figure></p>
</div>
        </article>
      
      
        <article class="post">
          <header class="page-header">
    
      <p class="meta text-muted text-uppercase">
        <span class="glyphicon glyphicon-calendar"></span> <time datetime="2013-02-03T11:09:23-06:00" pubdate class="published updated" >Feb 03, 2013</time>
        
      </p>
    
    
      <h1 class="entry-title"><a href="/blog/2013/02/03/saml-matching-endpoints-with-tomcat/">SAML Matching Endpoints With Tomcat</a></h1>
    
  </header>


  <div class="entry-content clearfix"><p>Getting, SAML message intended destination endpoint did not match recipient endpoint, errors mean the server itself dosen’t match the urls being given in the SAML messages.</p>

<p>We are using the Grails Spring Security SAML Plugin on a Tomcat server. In my case this was happening because we were doing SSL offloading on the load balancer. So if you look at the logs there should be an error log with the intended destination and the recipient endpoint.</p>

<p>In my case the first error was only different by http vs https. The fix for that was simply to apply the scheme attribute to that connector in tomcat. At which point everything was matching except that the port was now being added as 80 in my endpoint and that wasn’t in the intended endpoint. The fix for this was just to add the proxyPort to the connector as well.</p>

<p>So to fully support the OpenSAML on tomcat with SSL offloading I configured the connector as seen below. Take note of the scheme and proxyPort being set.</p>

<p><figure class='code-highlight-figure'><div class='code-highlight'><pre class='code-highlight-pre'><div data-line='1' class='code-highlight-row numbered'><div class='code-highlight-line'>    <span class="nt">&lt;Connector</span> <span class="na">port=</span><span class="s">&ldquo;8080&rdquo;</span> <span class="na">protocol=</span><span class="s">&ldquo;HTTP/1.1&rdquo;</span>
</div></div><div data-line='2' class='code-highlight-row numbered'><div class='code-highlight-line'>                   <span class="na">enableLookups=</span><span class="s">&ldquo;false&rdquo;</span>
</div></div><div data-line='3' class='code-highlight-row numbered'><div class='code-highlight-line'>                   <span class="na">maxThreads=</span><span class="s">&ldquo;250&rdquo;</span>
</div></div><div data-line='4' class='code-highlight-row numbered'><div class='code-highlight-line'>                   <span class="na">connectionTimeout=</span><span class="s">&ldquo;20000&rdquo;</span>
</div></div><div data-line='5' class='code-highlight-row numbered'><div class='code-highlight-line'>                   <span class="na">scheme=</span><span class="s">&ldquo;https&rdquo;</span><br/>
</div></div><div data-line='6' class='code-highlight-row numbered'><div class='code-highlight-line'>                   <span class="na">proxyPort=</span><span class="s">&ldquo;443&rdquo;</span><span class="nt">/&gt;</span>
</div></div></pre></div></figure></p>

<!-- more -->


<p><figure class='code-highlight-figure'><div class='code-highlight'><pre class='code-highlight-pre'><div data-line='1' class='code-highlight-row numbered'><div class='code-highlight-line'>    3377265 2013-02-01 11:31:30,997 ERROR [http-8080-9] decoding.BaseSAMLMessageDecoder.checkEndpointURI (BaseSAMLMessageDecoder.java:215) - SAML message intended destination endpoint &lsquo;<a href="https://example.com/app/saml/SSO/alias/https://example.com">https://example.com/app/saml/SSO/alias/https://example.com</a>&rsquo; did not match the recipient endpoint &lsquo;<a href="https://example.com:80/app/saml/SSO/alias/https://example.com">https://example.com:80/app/saml/SSO/alias/https://example.com</a>&rsquo;
</div></div><div data-line='2' class='code-highlight-row numbered'><div class='code-highlight-line'>    Feb 1, 2013 11:31:30 AM org.apache.catalina.core.StandardWrapperValve invoke
</div></div><div data-line='3' class='code-highlight-row numbered'><div class='code-highlight-line'>    SEVERE: Servlet.service() for servlet default threw exception
</div></div><div data-line='4' class='code-highlight-row numbered'><div class='code-highlight-line'>    org.opensaml.common.SAMLRuntimeException: Incoming SAML message is invalid
</div></div><div data-line='5' class='code-highlight-row numbered'><div class='code-highlight-line'>            at org.springframework.security.saml.SAMLProcessingFilter.attemptAuthentication(SAMLProcessingFilter.java:93)
</div></div><div data-line='6' class='code-highlight-row numbered'><div class='code-highlight-line'>            at org.springframework.security.web.authentication.AbstractAuthenticationProcessingFilter.doFilter(AbstractAuthenticationProcessingFilter.java:199)
</div></div><div data-line='7' class='code-highlight-row numbered'><div class='code-highlight-line'>            at org.springframework.security.web.FilterChainProxy$VirtualFilterChain.doFilter(FilterChainProxy.java:381)
</div></div><div data-line='8' class='code-highlight-row numbered'><div class='code-highlight-line'>            at org.springframework.security.saml.metadata.MetadataDisplayFilter.doFilter(MetadataDisplayFilter.java:83)
</div></div><div data-line='9' class='code-highlight-row numbered'><div class='code-highlight-line'>            at org.springframework.security.web.FilterChainProxy$VirtualFilterChain.doFilter(FilterChainProxy.java:381)
</div></div><div data-line='10' class='code-highlight-row numbered'><div class='code-highlight-line'>            at org.springframework.security.saml.SAMLEntryPoint.doFilter(SAMLEntryPoint.java:102)
</div></div><div data-line='11' class='code-highlight-row numbered'><div class='code-highlight-line'>            at org.springframework.security.web.FilterChainProxy$VirtualFilterChain.doFilter(FilterChainProxy.java:381)
</div></div><div data-line='12' class='code-highlight-row numbered'><div class='code-highlight-line'>            at org.springframework.security.web.context.SecurityContextPersistenceFilter.doFilter(SecurityContextPersistenceFilter.java:79)
</div></div><div data-line='13' class='code-highlight-row numbered'><div class='code-highlight-line'>            at org.springframework.security.web.FilterChainProxy$VirtualFilterChain.doFilter(FilterChainProxy.java:381)
</div></div><div data-line='14' class='code-highlight-row numbered'><div class='code-highlight-line'>            at org.springframework.security.web.FilterChainProxy.doFilter(FilterChainProxy.java:168)
</div></div><div data-line='15' class='code-highlight-row numbered'><div class='code-highlight-line'>            at org.springframework.web.filter.DelegatingFilterProxy.invokeDelegate(DelegatingFilterProxy.java:346)
</div></div><div data-line='16' class='code-highlight-row numbered'><div class='code-highlight-line'>            at org.springframework.web.filter.DelegatingFilterProxy.doFilter(DelegatingFilterProxy.java:259)
</div></div><div data-line='17' class='code-highlight-row numbered'><div class='code-highlight-line'>            at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:235)
</div></div><div data-line='18' class='code-highlight-row numbered'><div class='code-highlight-line'>            at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:206)
</div></div><div data-line='19' class='code-highlight-row numbered'><div class='code-highlight-line'>            at org.codehaus.groovy.grails.web.servlet.mvc.GrailsWebRequestFilter.doFilterInternal(GrailsWebRequestFilter.java:69)
</div></div><div data-line='20' class='code-highlight-row numbered'><div class='code-highlight-line'>            at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:76)
</div></div><div data-line='21' class='code-highlight-row numbered'><div class='code-highlight-line'>            at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:235)
</div></div><div data-line='22' class='code-highlight-row numbered'><div class='code-highlight-line'>            at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:206)
</div></div><div data-line='23' class='code-highlight-row numbered'><div class='code-highlight-line'>            at org.codehaus.groovy.grails.web.filters.HiddenHttpMethodFilter.doFilterInternal(HiddenHttpMethodFilter.java:65)
</div></div><div data-line='24' class='code-highlight-row numbered'><div class='code-highlight-line'>            at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:76)
</div></div><div data-line='25' class='code-highlight-row numbered'><div class='code-highlight-line'>            at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:235)
</div></div><div data-line='26' class='code-highlight-row numbered'><div class='code-highlight-line'>            at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:206)
</div></div><div data-line='27' class='code-highlight-row numbered'><div class='code-highlight-line'>            at org.springframework.web.filter.CharacterEncodingFilter.doFilterInternal(CharacterEncodingFilter.java:88)
</div></div><div data-line='28' class='code-highlight-row numbered'><div class='code-highlight-line'>            at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:76)
</div></div><div data-line='29' class='code-highlight-row numbered'><div class='code-highlight-line'>            at org.springframework.web.filter.DelegatingFilterProxy.invokeDelegate(DelegatingFilterProxy.java:346)
</div></div><div data-line='30' class='code-highlight-row numbered'><div class='code-highlight-line'>            at org.springframework.web.filter.DelegatingFilterProxy.doFilter(DelegatingFilterProxy.java:259)
</div></div><div data-line='31' class='code-highlight-row numbered'><div class='code-highlight-line'>            at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:235)
</div></div><div data-line='32' class='code-highlight-row numbered'><div class='code-highlight-line'>            at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:206)
</div></div><div data-line='33' class='code-highlight-row numbered'><div class='code-highlight-line'>            at org.apache.catalina.core.StandardWrapperValve.invoke(StandardWrapperValve.java:233)
</div></div><div data-line='34' class='code-highlight-row numbered'><div class='code-highlight-line'>            at org.apache.catalina.core.StandardContextValve.invoke(StandardContextValve.java:191)
</div></div><div data-line='35' class='code-highlight-row numbered'><div class='code-highlight-line'>            at org.apache.catalina.core.StandardHostValve.invoke(StandardHostValve.java:127)
</div></div><div data-line='36' class='code-highlight-row numbered'><div class='code-highlight-line'>            at org.apache.catalina.valves.ErrorReportValve.invoke(ErrorReportValve.java:102)
</div></div><div data-line='37' class='code-highlight-row numbered'><div class='code-highlight-line'>            at org.apache.catalina.core.StandardEngineValve.invoke(StandardEngineValve.java:109)
</div></div><div data-line='38' class='code-highlight-row numbered'><div class='code-highlight-line'>            at org.apache.catalina.connector.CoyoteAdapter.service(CoyoteAdapter.java:298)
</div></div><div data-line='39' class='code-highlight-row numbered'><div class='code-highlight-line'>            at org.apache.coyote.http11.Http11AprProcessor.process(Http11AprProcessor.java:864)
</div></div><div data-line='40' class='code-highlight-row numbered'><div class='code-highlight-line'>            at org.apache.coyote.http11.Http11AprProtocol$Http11ConnectionHandler.process(Http11AprProtocol.java:579)
</div></div><div data-line='41' class='code-highlight-row numbered'><div class='code-highlight-line'>            at org.apache.tomcat.util.net.AprEndpoint$Worker.run(AprEndpoint.java:1665)
</div></div><div data-line='42' class='code-highlight-row numbered'><div class='code-highlight-line'>            at java.lang.Thread.run(Thread.java:662)
</div></div><div data-line='43' class='code-highlight-row numbered'><div class='code-highlight-line'>    Caused by: org.opensaml.xml.security.SecurityException: SAML message intended destination endpoint did not match recipient endpoint
</div></div><div data-line='44' class='code-highlight-row numbered'><div class='code-highlight-line'>            at org.opensaml.common.binding.decoding.BaseSAMLMessageDecoder.checkEndpointURI(BaseSAMLMessageDecoder.java:217)
</div></div><div data-line='45' class='code-highlight-row numbered'><div class='code-highlight-line'>            at org.opensaml.saml2.binding.decoding.BaseSAML2MessageDecoder.decode(BaseSAML2MessageDecoder.java:72)
</div></div><div data-line='46' class='code-highlight-row numbered'><div class='code-highlight-line'>            at org.springframework.security.saml.processor.SAMLProcessorImpl.retrieveMessage(SAMLProcessorImpl.java:105)
</div></div><div data-line='47' class='code-highlight-row numbered'><div class='code-highlight-line'>            at org.springframework.security.saml.processor.SAMLProcessorImpl.retrieveMessage(SAMLProcessorImpl.java:172)
</div></div><div data-line='48' class='code-highlight-row numbered'><div class='code-highlight-line'>            at org.springframework.security.saml.SAMLProcessingFilter.attemptAuthentication(SAMLProcessingFilter.java:77)
</div></div><div data-line='49' class='code-highlight-row numbered'><div class='code-highlight-line'>            &hellip; 37 more
</div></div><div data-line='50' class='code-highlight-row numbered'><div class='code-highlight-line'>    Servlet.service() for servlet default threw exception
</div></div><div data-line='51' class='code-highlight-row numbered'><div class='code-highlight-line'>    org.opensaml.common.SAMLRuntimeException: Incoming SAML message is invalid
</div></div><div data-line='52' class='code-highlight-row numbered'><div class='code-highlight-line'>            at java.lang.Thread.run(Thread.java:662)
</div></div><div data-line='53' class='code-highlight-row numbered'><div class='code-highlight-line'>            Caused by: org.opensaml.xml.security.SecurityException: SAML message intended destination endpoint did not match recipient endpoint
</div></div><div data-line='54' class='code-highlight-row numbered'><div class='code-highlight-line'>                    at org.opensaml.common.binding.decoding.BaseSAMLMessageDecoder.checkEndpointURI(BaseSAMLMessageDecoder.java:217)
</div></div><div data-line='55' class='code-highlight-row numbered'><div class='code-highlight-line'>                    at org.opensaml.saml2.binding.decoding.BaseSAML2MessageDecoder.decode(BaseSAML2MessageDecoder.java:72)
</div></div><div data-line='56' class='code-highlight-row numbered'><div class='code-highlight-line'>            &hellip; 1 more
</div></div></pre></div></figure></p>
</div>
        </article>
      
      
        <article class="post">
          <header class="page-header">
    
      <p class="meta text-muted text-uppercase">
        <span class="glyphicon glyphicon-calendar"></span> <time datetime="2013-01-15T04:52:37-06:00" pubdate class="published updated" >Jan 15, 2013</time>
        
      </p>
    
    
      <h1 class="entry-title"><a href="/blog/2013/01/15/grails-display-the-current-spring-security-filter-chain/">Grails Display the Current Spring Security Filter Chain</a></h1>
    
  </header>


  <div class="entry-content clearfix"><p>While working with Grails and the Spring Security plugin, the current spring security filter chain is available in the <em>springSecurityFilterChain</em> bean. It is very easy with that to show what the current chain looks like so you can work through filter chain issues. I used the following code in the <a href="http://grails.org/plugin/console">Grails Console</a> plugin to get the bean:</p>

<p><figure class='code-highlight-figure'><div class='code-highlight'><pre class='code-highlight-pre'><div data-line='1' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="kt">def</span> <span class="n">filterChain</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">.</span><span class="na">getBean</span><span class="o">(</span><span class="s1">&lsquo;springSecurityFilterChain&rsquo;</span><span class="o">)</span>
</div></div></pre></div></figure></p>

<p>Also if you want to poke around the other beans available this is a great post to check out: <a href="http://www.redtoad.ca/ataylor/2012/05/spring-beans-from-the-grails-console/">Spring Beans from the Grails Console</a> .</p>
</div>
        </article>
      
      
        <article class="post">
          <header class="page-header">
    
      <p class="meta text-muted text-uppercase">
        <span class="glyphicon glyphicon-calendar"></span> <time datetime="2012-12-28T04:25:45-06:00" pubdate class="published updated" >Dec 28, 2012</time>
        
      </p>
    
    
      <h1 class="entry-title"><a href="/blog/2012/12/28/cassandra-not-available-after-starting/">Cassandra Not Available After Starting</a></h1>
    
  </header>


  <div class="entry-content clearfix"><p>I’ve been working with the DataStax Enterprise 2.01 install for a bit now and it was working great until one day I was no longer able to get any queries to work using the cqlsh I was just getting the error that one or more nodes was unavailable. I tried restarting and still nothing would work I got a few errors in the logs (shown below).</p>

<p>I was able to quickly fix the error by removing my data directory and starting fresh as this is just my development environment that works great for me. You can find your data directory in the cassandra.yaml file ($DSE_HOME/resources/cassandra/conf/cassandra.yaml), look for the <em>data_file_directories</em> entry. Mine was set to <em>/var/lib/cassandra/data</em> so I just ran the following and started cassandra fresh and everything is back to working order.</p>

<p><figure class='code-highlight-figure'><div class='code-highlight'><pre class='code-highlight-pre'><div data-line='1' class='code-highlight-row numbered'><div class='code-highlight-line'><span class="nb">rm</span> <span class="nt">-r</span> /var/lib/cassandra/data
</div></div></pre></div></figure></p>

<p><figure class='code-highlight-figure'><div class='code-highlight'><pre class='code-highlight-pre'><div data-line='1' class='code-highlight-row numbered'><div class='code-highlight-line'>    INFO [JOB-TRACKER-INIT] 2012-12-28 10:32:32,515 JobTracker.java (line 2427) problem cleaning system directory: cfs:/tmp/hadoop-jeffbeck/mapred/system
</div></div><div data-line='2' class='code-highlight-row numbered'><div class='code-highlight-line'>    java.io.IOException: UnavailableException()
</div></div><div data-line='3' class='code-highlight-row numbered'><div class='code-highlight-line'>        at com.datastax.bdp.hadoop.cfs.CassandraFileSystemThriftStore.listSubPaths(CassandraFileSystemThriftStore.java:1137)
</div></div><div data-line='4' class='code-highlight-row numbered'><div class='code-highlight-line'>        at com.datastax.bdp.hadoop.cfs.CassandraFileSystem.listStatus(CassandraFileSystem.java:192)
</div></div><div data-line='5' class='code-highlight-row numbered'><div class='code-highlight-line'>        at org.apache.hadoop.mapred.JobTracker.&lt;init>(JobTracker.java:2392)
</div></div><div data-line='6' class='code-highlight-row numbered'><div class='code-highlight-line'>        at org.apache.hadoop.mapred.JobTracker.&lt;init>(JobTracker.java:2195)
</div></div><div data-line='7' class='code-highlight-row numbered'><div class='code-highlight-line'>        at org.apache.hadoop.mapred.JobTracker.&lt;init>(JobTracker.java:2189)
</div></div><div data-line='8' class='code-highlight-row numbered'><div class='code-highlight-line'>        at org.apache.hadoop.mapred.JobTracker.startTracker(JobTracker.java:303)
</div></div><div data-line='9' class='code-highlight-row numbered'><div class='code-highlight-line'>        at org.apache.hadoop.mapred.JobTracker.startTracker(JobTracker.java:294)
</div></div><div data-line='10' class='code-highlight-row numbered'><div class='code-highlight-line'>       at org.apache.hadoop.mapred.HadoopTrackerPlugin$1.run(HadoopTrackerPlugin.java:230)
</div></div><div data-line='11' class='code-highlight-row numbered'><div class='code-highlight-line'>       at java.lang.Thread.run(Thread.java:680)
</div></div><div data-line='12' class='code-highlight-row numbered'><div class='code-highlight-line'>    Caused by: UnavailableException()
</div></div><div data-line='13' class='code-highlight-row numbered'><div class='code-highlight-line'>       at org.apache.cassandra.service.ReadCallback.assureSufficientLiveNodes(ReadCallback.java:212)
</div></div><div data-line='14' class='code-highlight-row numbered'><div class='code-highlight-line'>       at org.apache.cassandra.service.StorageProxy.scan(StorageProxy.java:1083)
</div></div><div data-line='15' class='code-highlight-row numbered'><div class='code-highlight-line'>       at org.apache.cassandra.thrift.CassandraServer.get_indexed_slices(CassandraServer.java:746)
</div></div><div data-line='16' class='code-highlight-row numbered'><div class='code-highlight-line'>       at com.datastax.bdp.hadoop.cfs.CassandraFileSystemThriftStore.listSubPaths(CassandraFileSystemThriftStore.java:1120)
</div></div><div data-line='17' class='code-highlight-row numbered'><div class='code-highlight-line'>       &hellip; 8 more
</div></div></pre></div></figure></p>
</div>
        </article>
      
    </div>

    <ul class="pager">
      
        <li class="previous"><a href="3">&larr;&nbsp;Older</a></li>
      
      <li><a href="/blog/archives/">Blog Archives</a></li>
      
        <li class="next"><a href="1">Newer&nbsp;&rarr;</a></li>
      
    </ul>
  </div>

  
    <aside class="sidebar col-md-3">
      
        
<link rel="stylesheet" type="text/css" href="https://s.gravatar.com/css/hovercard.css">
<section class="panel panel-default clearfix">
	<span>
		<div class='gcard grofile' style='position: relative; min-width:210px; margin: 0px auto;'><div class='grav-inner gcard-about'><div class='grav-grav' style='width: 100px; margin: 0px auto 10px; float: none;'><a href='http://gravatar.com/beckje01' target='_blank'><img src='https://www.gravatar.com/avatar/83e830833b762cc8c5c46867104ebdb9' width='100' height='100' style='border: none'></a></div><div class='grav-info' style='float: none; margin: 0px auto; style: auto;'><h4><a href=http://gravatar.com/beckje01' target='_blank'>Jeff Beck</a></h4><p class='grav-loc'>Minneapolis</p><p class='grav-about'></p><div class='grav-view-complete-button'><a href='http://gravatar.com/beckje01' target='_blank' class='grav-view-complete'>View Compelete Profile</a></div></div><div style='clear:both'></div></div><div class='grav-cardarrow'></div><div class='grav-tag'><a href='https://gravatar.com' title='Powered by Gravatar.com'target='_blank'>&nbsp;</a></div>
	</span>
</section>

<section class="panel panel-default">
  <div class="panel-heading">
    <h3 class="panel-title">Recent Posts</h3>
  </div>
  
  <div id="recent_posts" class="list-group">
    
    <a class="list-group-item " href="/blog/2016/07/28/grails-3-dot-1-9-functional-tests/">Grails 3.1.9 Functional Test Port</a>
    
    <a class="list-group-item " href="/blog/2016/06/19/grails-3-metrics-and-pathtokens/">Grails 3 Metrics and Path Variables</a>
    
    <a class="list-group-item " href="/blog/2015/11/28/rxjava-and-ratpack-testing-gotcha/">RxJava and Ratpack Testing Gotcha</a>
    
    <a class="list-group-item " href="/blog/2015/07/12/grails-3-and-jacoco/">Grails 3 and JaCoCo</a>
    
    <a class="list-group-item " href="/blog/2015/05/17/vertx3-and-gradle-application-plugin/">Vertx3 and Gradle Application Plugin</a>
    
  </div>
</section>

<section class='googleplus googleplus-hidden panel panel-default'>
  <div class="panel-body">
    <h1>
      <a href="https://plus.google.com/109464939117502989633?rel=author">
        <img src="http://www.google.com/images/icons/ui/gprofile_button-32.png" width="32" height="32">
        Google+
      </a>
    </h1>
  </div>
</section>



<section class="panel panel-default clearfix">
<div class="panel-heading">
  <h3 class="panel-title">Coderwall</h3>
</div>
  <ul id="cw_badges">
    <li class="loading">Status updating...</li>
  </ul>

  <script type="text/javascript">
    var coderwall = (function(){
      function render(options, badges){
        var fragment = '',
            t = $(options.target),
            height = 65,
            width = 65,
            index;

        for (index in badges) {
          fragment += '<a class="cw_badge"title="' + badges[index].description + '" href="https://coderwall.com/' + options.user + '">';
          fragment +=   '<img alt="' + badges[index].description + '" height="' + width + '" width="' + height + '" src="' + badges[index].badge + '"/>';
          fragment += '</a>';
        }

        t.html(fragment);
      }
      return {
        showBadges: function(options){
          $.ajax({
              url: 'https://coderwall.com/' + options.user + '.json?callback=?'
            , dataType: 'jsonp'
            , error: function (err) { $(options.target + ' li.loading').addClass('error').text("Error loading feed"); }
            , success: function(res) {
                render(options, res.badges);
            }
          });
        }
      };
    })();

    $(document).ready(function(){
      coderwall.showBadges({
        user: 'beckje01',
        target: '#cw_badges'
      });
    });
  </script>
  <style type="text/css">
    .cw_badge img {
      padding: 5px;
      border: 0 none !important;
      -moz-box-shadow: none !important;
      -webkit-box-shadow: none !important;
      -o-box-shadow: none !important;
      box-shadow: none !important;
    }
  </style>
</section>


      
    </aside>
  
</div>

        </div>
      </div>
    </div>
    <footer role="contentinfo"><div class="container">
    <p class="text-muted credits">
  Copyright &copy; 2020 - Jeff Beck<br>
  <small>
      <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>,
      <span class="credit">customized with <a href="https://github.com/kAworu/octostrap3">octostrap3</a></span>.
  </small>
</p>
</div></footer>
    <script src="/assets/bootstrap/dist/js/bootstrap.min.js"></script>
<script src="/javascripts/modernizr-2.0.js"></script>
<script type="text/javascript">
      var disqus_shortname = 'beckje01blog';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = ('https:' == document.location.protocol ? 'https://' : 'http://') + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>


<script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>
  </body>
</html>
